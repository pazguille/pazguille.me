<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <title>POC Videos</title>
  <link href="https://unpkg.com/video.js@7.19.2/dist/video-js.min.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background-color: black;
    }

    [hidden] {
      display: none !important;
    }

    .carousel {
      display: flex;
      padding: 0;
      margin: 0;
      width: 100vw;
      height: 100vh;
      background-color: black;
      list-style: none;
      position: relative;

      overflow-y: auto;
      overflow-x: hidden;
      flex-direction: column;
      overscroll-behavior-y: contain;
      scroll-snap-type: y mandatory;
    }

    .carousel li {
      flex: none;
      display: flex;
      width: 100vw;
      height: 100vh;
      align-items: center;
      justify-content: center;
      scroll-snap-align: center;

      position: relative;
    }

    .video {
      position: relative;
      overflow: hidden;
      width: 360px;
      height: 205px;
    }

    .player {
      position: absolute;
      top: 50%;
      margin-top: -103px;
      pointer-events: none;
      touch-action: none;
    }

    .player,
    .player video {
      width: 100vw;
      height: 205px;
    }

    #preload,
    #preload video {
      position: absolute;
      z-index: -1;
      left: -100vh;
    }

    .vjs-hidden {
      opacity: 0;
      display: block !important;
    }

    .vjs-loading-spinner {
      display: none !important;
    }
  </style>
</head>

<body>
  <main>
    <ul class="carousel">
      <li data-index="0">
        <img class="video" decoding="async" height="360" height="203" src="poster-2.png" />
        <video id="player" class="player" playsinline preload="auto" muted></video>
      </li>
      <li data-index="1"><img class="video" decoding="async" height="360" height="203" src="poster-3.png" /></li>
      <li data-index="2"><img class="video" decoding="async" height="360" height="203" src="poster-0.png" /></li>
      <li data-index="3"><img class="video" decoding="async" height="360" height="203" src="poster-1.png" /></li>
    </ul>

    <video id="preload" playsinline preload="auto" autoplay muted></video>
  </main>

  <script src="https://unpkg.com/video.js@7.19.2/dist/video.js"></script>
  <script src="https://unpkg.com/@videojs/http-streaming@2.14.2/dist/videojs-http-streaming.js"></script>
  <script>
    const playlist = [
      'https://d349iirefh69i6.cloudfront.net/ivs/v1/013436950636/LFSEeA7B6u4J/2022/6/8/17/58/tT1xdMFcyka2/media/hls/recorded/master.m3u8',
      'https://d349iirefh69i6.cloudfront.net/ivs/v1/013436950636/NWUPfmW6DILF/2022/6/8/19/59/hRIk0FMVu4rS/media/hls/recorded/master.m3u8',
      'https://d349iirefh69i6.cloudfront.net/ivs/v1/013436950636/rs5SKrr5vMiA/2022/6/7/21/51/p60TwVnFoWNV/media/hls/recorded/master.m3u8',
      'https://d349iirefh69i6.cloudfront.net/ivs/v1/013436950636/HHG33LGjFF0G/2022/6/8/13/42/aH4nynSO9tPf/media/hls/recorded/master.m3u8',
    ];

    const poster = [
      'poster-2.png',
      'poster-3.png',
      'poster-0.png',
      'poster-1.png',
    ];

    const $carousel = document.querySelector('.carousel');

    const player = videojs('player', {
      controls: false,
    });
    const $video = player.el_.querySelector('video');

    // player.poster(poster[0]); => No anda como esperamos
    $video.poster = poster[0];

    player.src({
      type: 'application/x-mpegURL',
      src: playlist[0]
    });

    player.on('loadedmetadata', () => {
      $carousel.children[index].appendChild(player.el_);
      player.show();
      player.play();
    });

    const preload = videojs('preload');
    preload.src({
      type: 'application/x-mpegURL',
      src: playlist[1]
    });

    document.querySelector('body').addEventListener('click', () => {
      player.muted(false);
      player.play();
    }, { once: true });


    let index = 0;
    let $current = null;

    const io = new IntersectionObserver(async (entries) => {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          $current = entry.target;
          if (index === Number($current.dataset.index)) {
            return;
          }

          index = Number($current.dataset.index);

          $video.poster = poster[index]; // remove default poster on android

          setTimeout(() => {
            player.src({
              type: 'application/x-mpegURL',
              src: playlist[index],
            });
            player.hide();
          }, 25);

          setTimeout(() => {
            if (index + 1 < playlist.length && playlist[index + 1]) {
              preload.src({
                type: 'application/x-mpegURL',
                src: playlist[index + 1]
              });
            }
          }, 650);
        }
      });
    }, {
      root: $carousel,
      threshold: 0.95,
      rootMargin: '0px',
    });

    const videos = document.querySelectorAll('.carousel > li');
    videos.forEach((video) => {
      io.observe(video);
    });

  </script>
</body>

</html>
